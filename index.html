<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­”é¢˜ç³»ç»Ÿ</title>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ï¼Œè¿™é‡Œçœç•¥ä»¥èŠ‚çœç©ºé—´ */
        /* æ‰€æœ‰CSSæ ·å¼éƒ½ä¿æŒä¸å˜ */
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="login-screen" class="card">
            <h1>ç­”é¢˜ç³»ç»Ÿ</h1>
            
            <div class="github-info">
                <p style="margin: 0; font-weight: bold; color: #155724;">
                    <span class="online-indicator"></span>
                    å®æ—¶æ’è¡Œæ¦œç³»ç»Ÿ
                </p>
            </div>

            <div class="instructions">
                <p><strong>ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
                <p>1. è¾“å…¥æ˜µç§°å¼€å§‹ç­”é¢˜</p>
                <p>2. å¼€å§‹ç­”é¢˜åæœ‰10åˆ†é’Ÿæ—¶é—´å®Œæˆæäº¤</p>
                <p>3. å¿…é¡»åœ¨10åˆ†é’Ÿå†…å®Œæˆæ‰€æœ‰é¢˜ç›®å¹¶æäº¤</p>
                <p>4. è¶…æ—¶æäº¤å°†æ— æ³•ä¿å­˜æˆç»©</p>
            </div>

            <!-- æ—¶é—´é…ç½®åŒºåŸŸ -->
            <div class="time-config">
                <p style="margin-bottom: 10px; font-weight: bold;">ç­”é¢˜æ—¶é—´è®¾ç½®</p>
                <div class="form-group">
                    <label for="quiz-duration">ç­”é¢˜æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š</label>
                    <select id="quiz-duration" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                        <option value="5">5åˆ†é’Ÿï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰</option>
                        <option value="10" selected>10åˆ†é’Ÿï¼ˆæ ‡å‡†æ¨¡å¼ï¼‰</option>
                    </select>
                </div>
                <div id="time-status" class="sync-status" style="display: none;"></div>
            </div>
            
            <div class="form-group">
                <label for="nickname">è¯·è¾“å…¥æ‚¨çš„æ˜µç§°ï¼š</label>
                <input type="text" id="nickname" placeholder="è¯·è¾“å…¥æ˜µç§°ï¼ˆ2-10ä¸ªå­—ç¬¦ï¼‰" maxlength="10">
            </div>
            
            <div class="flex">
                <button id="start-btn">å¼€å§‹ç­”é¢˜</button>
                <button id="view-ranking-btn" class="btn-secondary">å®æ—¶æ’è¡Œæ¦œ</button>
            </div>
            
            <div id="sync-status" class="sync-status" style="display: none;"></div>
        </div>

        <!-- ç­”é¢˜ç•Œé¢ -->
        <div id="quiz-screen" class="card hidden">
            <div class="user-info">
                <span>ç”¨æˆ·ï¼š<span id="current-user"></span></span>
                <span>è¿›åº¦ï¼š<span id="progress-text">0/0</span></span>
            </div>
            <div class="countdown-timer" id="countdown-timer">
                å‰©ä½™æ—¶é—´ï¼š10:00
            </div>
            <div class="progress">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="timer">
                ç”¨æ—¶ï¼š<span id="timer">00:00</span>
            </div>
            <div id="question-container">
                <!-- é¢˜ç›®å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </div>
            <div class="flex">
                <button id="prev-btn" class="btn-secondary">ä¸Šä¸€é¢˜</button>
                <button id="next-btn">ä¸‹ä¸€é¢˜</button>
            </div>
        </div>

        <!-- ç»“æœç•Œé¢ -->
        <div id="result-screen" class="card hidden">
            <div class="result">
                <h2 id="result-title">ç­”é¢˜å®Œæˆï¼</h2>
                <p>æ‚¨çš„å¾—åˆ†ï¼š</p>
                <div class="score" id="final-score">0</div>
                <p class="time-used">ç”¨æ—¶ï¼š<span id="final-time">00:00</span></p>
                <div class="sync-status" id="upload-status" style="display: none;"></div>
                <div class="flex">
                    <button id="view-ranking-btn-2">æŸ¥çœ‹å®æ—¶æ’è¡Œæ¦œ</button>
                    <button id="restart-btn" class="btn-secondary">å†ç­”ä¸€æ¬¡</button>
                    <button id="create-issue-btn" class="btn-success">åˆ›å»ºGitHub Issue</button>
                </div>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œç•Œé¢ -->
        <div id="ranking-screen" class="card hidden">
            <div class="flex">
                <h2>å®æ—¶æ’è¡Œæ¦œ</h2>
                <div style="display: flex; align-items: center;">
                    <span class="online-indicator"></span>
                    <span style="font-size: 14px; color: #28a745;">æœ¬åœ°æ•°æ®å­˜å‚¨</span>
                </div>
            </div>
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>æ˜µç§°</th>
                        <th>åˆ†æ•°</th>
                        <th>ç”¨æ—¶</th>
                        <th>æäº¤æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody id="ranking-body">
                    <!-- æ’è¡Œæ¦œæ•°æ®å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                </tbody>
            </table>
            <div style="margin-top: 20px; text-align: center;">
                <button id="back-to-start-btn">è¿”å›é¦–é¡µ</button>
                <button id="refresh-ranking-btn" class="btn-secondary" style="margin-left: 10px;">åˆ·æ–°æ’è¡Œæ¦œ</button>
                <button id="auto-refresh-toggle" class="btn-success" style="margin-left: 10px;">è‡ªåŠ¨åˆ·æ–°: å¼€</button>
            </div>
        </div>
    </div>

    <script>
        // ==== æ—¶é—´ç®¡ç† ====
        const TimeManager = {
            quizStartTime: null,      // ç”¨æˆ·å¼€å§‹ç­”é¢˜çš„æ—¶é—´
            timeLimit: 10 * 60 * 1000, // é»˜è®¤10åˆ†é’Ÿï¼Œå•ä½æ¯«ç§’
            countdownInterval: null,
            timeRemaining: 0,
            
            // åˆå§‹åŒ–æ—¶é—´è®¾ç½®
            init() {
                // è®¾ç½®é»˜è®¤æ—¶é—´é™åˆ¶
                this.updateTimeLimit();
                
                // ç›‘å¬æ—¶é—´é™åˆ¶é€‰æ‹©å˜åŒ–
                document.getElementById('quiz-duration').addEventListener('change', () => {
                    this.updateTimeLimit();
                });
            },
            
            // æ›´æ–°æ—¶é—´é™åˆ¶
            updateTimeLimit() {
                const durationSelect = document.getElementById('quiz-duration');
                const minutes = parseInt(durationSelect.value);
                this.timeLimit = minutes * 60 * 1000;
                
                this.showTimeStatus(`å·²è®¾ç½®ç­”é¢˜æ—¶é—´ï¼š${minutes}åˆ†é’Ÿ`, 'sync-success');
            },
            
            // å¼€å§‹ç­”é¢˜è®¡æ—¶
            startQuiz() {
                this.quizStartTime = new Date();
                this.timeRemaining = this.timeLimit;
                this.startCountdown();
                
                console.log(`ç­”é¢˜å¼€å§‹æ—¶é—´: ${this.quizStartTime.toLocaleString()}`);
                console.log(`æ—¶é—´é™åˆ¶: ${this.timeLimit/1000}ç§’`);
            },
            
            // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
            isTimeUp() {
                if (!this.quizStartTime) return false;
                
                const now = new Date();
                const timeElapsed = now - this.quizStartTime;
                return timeElapsed > this.timeLimit;
            },
            
            // è·å–å‰©ä½™æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            getRemainingTime() {
                if (!this.quizStartTime) return this.timeLimit;
                
                const now = new Date();
                const timeElapsed = now - this.quizStartTime;
                return Math.max(0, this.timeLimit - timeElapsed);
            },
            
            // å¼€å§‹å€’è®¡æ—¶
            startCountdown() {
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                }
                
                this.countdownInterval = setInterval(() => {
                    this.timeRemaining = this.getRemainingTime();
                    
                    if (this.timeRemaining <= 0) {
                        this.timeRemaining = 0;
                        this.stopCountdown();
                        this.handleTimeUp();
                        return;
                    }
                    
                    this.updateCountdownDisplay();
                    
                    // æ ¹æ®å‰©ä½™æ—¶é—´æ”¹å˜æ ·å¼
                    this.updateCountdownStyle();
                }, 1000);
                
                this.updateCountdownDisplay();
                this.updateCountdownStyle();
            },
            
            // åœæ­¢å€’è®¡æ—¶
            stopCountdown() {
                if (this.countdownInterval) {
                    clearInterval(this.countdownInterval);
                    this.countdownInterval = null;
                }
            },
            
            // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
            updateCountdownDisplay() {
                const minutes = Math.floor(this.timeRemaining / 60000);
                const seconds = Math.floor((this.timeRemaining % 60000) / 1000);
                const countdownElement = document.getElementById('countdown-timer');
                
                countdownElement.textContent = `å‰©ä½™æ—¶é—´ï¼š${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            },
            
            // æ›´æ–°å€’è®¡æ—¶æ ·å¼
            updateCountdownStyle() {
                const countdownElement = document.getElementById('countdown-timer');
                
                // ç§»é™¤æ‰€æœ‰æ ·å¼ç±»
                countdownElement.classList.remove('countdown-warning', 'countdown-danger');
                
                if (this.timeRemaining <= 60000) {
                    // æœ€å1åˆ†é’Ÿï¼šçº¢è‰²è­¦å‘Š
                    countdownElement.classList.add('countdown-danger');
                } else if (this.timeRemaining <= 180000) {
                    // æœ€å3åˆ†é’Ÿï¼šé»„è‰²è­¦å‘Š
                    countdownElement.classList.add('countdown-warning');
                }
            },
            
            // å¤„ç†æ—¶é—´ç»“æŸ
            handleTimeUp() {
                const countdownElement = document.getElementById('countdown-timer');
                countdownElement.textContent = 'æ—¶é—´åˆ°ï¼ç­”é¢˜å·²ç»“æŸ';
                countdownElement.classList.add('countdown-danger');
                
                // è‡ªåŠ¨æäº¤ç­”æ¡ˆ
                const nextBtn = document.getElementById('next-btn');
                if (nextBtn.textContent === 'æäº¤ç­”æ¡ˆ') {
                    nextBtn.click(); // è‡ªåŠ¨æäº¤
                } else {
                    // å¦‚æœç”¨æˆ·è¿˜åœ¨ç­”é¢˜ä¸­ï¼Œå¼ºåˆ¶æäº¤
                    submitQuiz();
                }
                
                // æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯
                setTimeout(() => {
                    alert('ç­”é¢˜æ—¶é—´å·²ç»“æŸï¼ç³»ç»Ÿå·²è‡ªåŠ¨æäº¤æ‚¨çš„ç­”æ¡ˆã€‚');
                }, 500);
            },
            
            // è·å–ç­”é¢˜ç”¨æ—¶ï¼ˆç§’ï¼‰
            getTimeUsed() {
                if (!this.quizStartTime) return 0;
                
                const now = new Date();
                const timeUsed = now - this.quizStartTime;
                return Math.min(Math.floor(timeUsed / 1000), this.timeLimit / 1000);
            },
            
            // æ£€æŸ¥æäº¤æ˜¯å¦æœ‰æ•ˆï¼ˆåœ¨æ—¶é—´é™åˆ¶å†…ï¼‰
            isValidSubmission() {
                return !this.isTimeUp();
            },
            
            // æ˜¾ç¤ºæ—¶é—´çŠ¶æ€
            showTimeStatus(message, type) {
                const statusEl = document.getElementById('time-status');
                if (!statusEl) return;
                
                statusEl.textContent = message;
                statusEl.className = `sync-status ${type}`;
                statusEl.style.display = 'block';
                
                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            },
            
            // é‡ç½®æ—¶é—´ç®¡ç†å™¨
            reset() {
                this.stopCountdown();
                this.quizStartTime = null;
                this.timeRemaining = this.timeLimit;
            }
        };

        // ==== æœ¬åœ°å­˜å‚¨æœåŠ¡ ====
        const StorageService = {
            autoRefreshInterval: null,
            autoRefreshEnabled: true,
            
            // åˆå§‹åŒ–
            init() {
                this.showSyncStatus('âœ… æœ¬åœ°æ’è¡Œæ¦œå·²å¯ç”¨', 'sync-success');
                
                // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
                this.startAutoRefresh();
            },
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ’è¡Œæ¦œæ•°æ®
            async loadRanking() {
                try {
                    this.showSyncStatus('æ­£åœ¨åŠ è½½æ’è¡Œæ¦œ...', 'sync-loading');
                    
                    const ranking = this.getLocalRanking();
                    
                    this.showSyncStatus('æ’è¡Œæ¦œåŠ è½½æˆåŠŸï¼', 'sync-success');
                    setTimeout(() => this.hideSyncStatus(), 2000);
                    
                    return ranking;
                } catch (error) {
                    console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
                    this.showSyncStatus('åŠ è½½å¤±è´¥', 'sync-error');
                    return this.getLocalRanking();
                }
            },
            
            // æœ¬åœ°å­˜å‚¨
            saveToLocalStorage(result) {
                let ranking = JSON.parse(localStorage.getItem('ranking')) || [];
                ranking.push({
                    ...result,
                    from: 'local',
                    id: Date.now(),
                    created_at: new Date().toISOString(),
                    valid_submission: TimeManager.isValidSubmission(),
                    time_used: result.time,
                    total: questions.length
                });
                
                ranking = this.deduplicateAndSort(ranking);
                
                if (ranking.length > 100) {
                    ranking = ranking.slice(0, 100);
                }
                
                localStorage.setItem('ranking', JSON.stringify(ranking));
            },
            
            getLocalRanking() {
                return JSON.parse(localStorage.getItem('ranking')) || [];
            },
            
            // å»é‡å’Œæ’åº
            deduplicateAndSort(ranking) {
                const uniqueMap = new Map();
                
                ranking.forEach(item => {
                    const key = `${item.nickname}-${item.score}-${item.time}`;
                    if (!uniqueMap.has(key) || (item.id && item.id > uniqueMap.get(key).id)) {
                        uniqueMap.set(key, item);
                    }
                });
                
                const uniqueRanking = Array.from(uniqueMap.values());
                
                uniqueRanking.sort((a, b) => {
                    if (a.score !== b.score) return b.score - a.score;
                    return a.time - b.time;
                });
                
                return uniqueRanking;
            },
            
            // è‡ªåŠ¨åˆ·æ–°
            startAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                }
                
                this.autoRefreshInterval = setInterval(async () => {
                    if (this.autoRefreshEnabled) {
                        await this.refreshRankingIfVisible();
                    }
                }, 5000); // 5ç§’åˆ·æ–°ä¸€æ¬¡
            },
            
            stopAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                    this.autoRefreshInterval = null;
                }
            },
            
            async refreshRankingIfVisible() {
                if (!document.getElementById('ranking-screen').classList.contains('hidden')) {
                    await refreshRanking();
                }
            },
            
            toggleAutoRefresh() {
                this.autoRefreshEnabled = !this.autoRefreshEnabled;
                const button = document.getElementById('auto-refresh-toggle');
                
                if (this.autoRefreshEnabled) {
                    button.textContent = 'è‡ªåŠ¨åˆ·æ–°: å¼€';
                    button.className = 'btn-success';
                    this.startAutoRefresh();
                } else {
                    button.textContent = 'è‡ªåŠ¨åˆ·æ–°: å…³';
                    button.className = 'btn-secondary';
                    this.stopAutoRefresh();
                }
            },
            
            // å·¥å…·å‡½æ•°
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            },
            
            // çŠ¶æ€æ˜¾ç¤º
            showSyncStatus(message, type) {
                const statusEl = document.getElementById('sync-status');
                if (!statusEl) return;
                
                statusEl.innerHTML = type === 'sync-loading' ? 
                    `<div class="loading"></div>${message}` : message;
                statusEl.className = `sync-status ${type}`;
                statusEl.style.display = 'block';
            },
            
            showUploadStatus(message, type) {
                const statusEl = document.getElementById('upload-status');
                if (!statusEl) return;
                
                statusEl.innerHTML = type === 'sync-loading' ? 
                    `<div class="loading"></div>${message}` : message;
                statusEl.className = `sync-status ${type}`;
                statusEl.style.display = 'block';
            },
            
            hideSyncStatus() {
                const statusEl = document.getElementById('sync-status');
                if (statusEl) {
                    statusEl.style.display = 'none';
                }
            }
        };

        // ==== é¢˜ç›®æ•°æ® ====
        const questions = [
            {
                id: 1,
                question: "éå…¨æ—¥åˆ¶ã€ä¸“å‡æœ¬ã€æˆäººé«˜è€ƒç­‰å½¢å¼çš„æ‹›ç”Ÿç”±ï¼ˆï¼‰è´Ÿè´£ã€‚",
                options: ["å‰æ—å¤§å­¦æœ¬ç§‘ç”Ÿæ‹›ç”ŸåŠå…¬å®¤", "å‰æ—å¤§å­¦ç»§ç»­æ•™è‚²å­¦é™¢", "å‰æ—å¤§å­¦å›½é™…æ•™è‚²å­¦é™¢", "å‰æ—å¤§å­¦è±å§†é¡¿å­¦é™¢"],
                answer: 1,
                type: "choice"
            },
            {
                id: 2,
                question: "ä¸‹åˆ—æŠ¥è€ƒæ–¹å¼ä¸­é‡‡å–åœ¨ä¸“ä¸šç»„å†…è°ƒå‰‚çš„æ˜¯ï¼ˆï¼‰ã€‚",
                options: ["é™¢æ ¡+ä¸“ä¸š", "é™¢æ ¡+ä¸“ä¸šç»„", "ä¸“ä¸š+é™¢æ ¡"],
                answer: 1,
                type: "choice"
            },
            {
                id: 3,
                question: "åœ¨2026å¹´é«˜è€ƒä¸­ï¼ˆï¼‰å’Œï¼ˆï¼‰å®è¡Œä¼ ç»Ÿæ–‡ç†åˆ†ç§‘çš„é€‰ç§‘æ¨¡å¼ã€‚",
                options: ["æ–°ç–†ã€é’æµ·", "æ–°ç–†ã€äº‘å—", "è¥¿è—ã€æ–°ç–†", "è¥¿è—ã€å®å¤"],
                answer: 2,
                type: "choice"
            },
            {
                id: 4,
                question: "â€œæ»‘æ¡£"çš„è€ƒç”Ÿåªèƒ½ç­‰å¾…ï¼ˆï¼‰å¾é›†å¿—æ„¿æˆ–ä¸‹ä¸€æ‰¹æ¬¡çš„å½•å–ã€‚",
                options: ["æœ¬æ‰¹æ¬¡", "ä¸Šä¸€æ‰¹æ¬¡", "ä¸‹ä¸€æ‰¹æ¬¡"],
                answer: 0,
                type: "choice"
            },
            {
                id: 5,
                question: "â€œæŠ•æ¡£â€å³ï¼ˆï¼‰æŠŠè€ƒç”Ÿæ¡£æ¡ˆæŠ•åˆ°äº†å¯¹åº”é™¢æ ¡ã€‚",
                options: ["é™¢æ ¡æ‹›ç”ŸåŠ", "è€ƒç”Ÿæœ¬äºº", "è€ƒç”Ÿæ‰€åœ¨é«˜ä¸­", "çœè€ƒè¯•é™¢"],
                answer: 3,
                type: "choice"
            },
            {
                id: 6,
                question: "å¹³è¡Œå¿—æ„¿å½•å–è§„åˆ™çš„æ ¸å¿ƒæ˜¯ï¼ˆï¼‰ä¼˜å…ˆã€éµå¾ªï¼ˆï¼‰ã€‚",
                type: "fill",
                correctAnswers: ["åˆ†æ•°", "å¿—æ„¿"],
                requiredMatches: 2
            },
            {
                id: 7,
                question: "å‰æ—å¤§å­¦æ‹›ç”Ÿåä¼šæ˜¯ï¼ˆï¼‰ç›´å±å­¦ç”Ÿç¤¾å›¢ã€‚",
                type: "fill",
                correctAnswers: ["å‰æ—å¤§å­¦æœ¬ç§‘ç”Ÿæ‹›ç”ŸåŠå…¬å®¤", "å‰å¤§æœ¬æ‹›åŠ"],
                requiredMatches: 2
            },
            {
                id: 8,
                question: "å‰æ—å¤§å­¦"2+7"æ‹”å°–äººæ‰åŸ¹å…»ä½“ç³»ä¸­çš„"2"æŒ‡çš„æ˜¯ï¼ˆï¼‰ç­å’Œï¼ˆï¼‰ç­ã€‚",
                type: "fill",
                correctAnswers: ["å”æ•–åº†", "åŒ¡äºšæ˜"],
                requiredMatches: 2
            },
            {
                id: 9,
                question: "ä¸¾å‡ºå‰æ—å¤§å­¦ä¸€ä¸ªä¸“ä¸šç‰¹è‰²ç­ï¼›ï¼ˆï¼‰ã€‚",
                type: "fill",
                correctAnswers: ["PPEï¼ˆå“²å­¦ã€æ”¿æ²»å­¦ã€ç»æµå­¦ï¼‰", "æ¶‰å¤–æ³•æ²»äººæ‰è¯•éªŒç­", "çœ¼ç§‘å­¦", "ç”Ÿç‰©è‚²ç§ç‰¹è‰²ç­", "é›†æˆç”µè·¯ç§‘æŠ€è‹±æ‰ç‰¹è‰²ç­", "PPE"],
                requiredMatches: 1
            },
            {
                id: 10,
                question: "å‰æ—å¤§å­¦æœ‰ï¼ˆï¼‰ä¸ª"åŒä¸€æµ"å»ºè®¾å­¦ç§‘ï¼ˆç¾¤ï¼‰ã€‚",
                type: "fill",
                correctAnswers: ["12"],
                requiredMatches: 1
            }
        ];

        // ==== åº”ç”¨çŠ¶æ€ ====
        let state = {
            currentUser: "",
            currentQuestionIndex: 0,
            userAnswers: [],
            startTime: null,
            timerInterval: null,
            elapsedTime: 0
        };

        // ==== DOMå…ƒç´  ====
        const loginScreen = document.getElementById('login-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const resultScreen = document.getElementById('result-screen');
        const rankingScreen = document.getElementById('ranking-screen');

        // ==== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ====
        function initApp() {
            // åˆå§‹åŒ–æ—¶é—´ç®¡ç†å™¨
            TimeManager.init();
            
            // åˆå§‹åŒ–å­˜å‚¨æœåŠ¡
            StorageService.init();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('start-btn').addEventListener('click', startQuiz);
            document.getElementById('view-ranking-btn').addEventListener('click', showRanking);
            document.getElementById('view-ranking-btn-2').addEventListener('click', showRanking);
            document.getElementById('prev-btn').addEventListener('click', prevQuestion);
            document.getElementById('next-btn').addEventListener('click', nextQuestion);
            document.getElementById('restart-btn').addEventListener('click', restartQuiz);
            document.getElementById('back-to-start-btn').addEventListener('click', backToStart);
            document.getElementById('refresh-ranking-btn').addEventListener('click', refreshRanking);
            document.getElementById('auto-refresh-toggle').addEventListener('click', () => {
                StorageService.toggleAutoRefresh();
            });
            document.getElementById('create-issue-btn').addEventListener('click', createGitHubIssue);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å·²ä¿å­˜çš„ç”¨æˆ·æ•°æ®
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                document.getElementById('nickname').value = savedUser;
            }
            
            // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            document.getElementById('nickname').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    startQuiz();
                }
            });
        }

        function startQuiz() {
            const nickname = document.getElementById('nickname').value.trim();
            if (!nickname) {
                alert('è¯·è¾“å…¥æ˜µç§°ï¼');
                return;
            }
            
            if (nickname.length < 2 || nickname.length > 10) {
                alert('æ˜µç§°é•¿åº¦åº”åœ¨2-10ä¸ªå­—ç¬¦ä¹‹é—´ï¼');
                return;
            }
            
            state.currentUser = nickname;
            state.currentQuestionIndex = 0;
            state.userAnswers = new Array(questions.length).fill(null);
            state.elapsedTime = 0;
            
            localStorage.setItem('currentUser', nickname);
            
            // å¼€å§‹è®¡æ—¶
            TimeManager.startQuiz();
            startTimer();
            
            loginScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            
            document.getElementById('current-user').textContent = nickname;
            
            loadQuestion();
        }

        function loadQuestion() {
            const question = questions[state.currentQuestionIndex];
            const questionContainer = document.getElementById('question-container');
            
            const progress = ((state.currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${state.currentQuestionIndex + 1}/${questions.length}`;
            
            let html = '';
            
            if (question.type === "choice") {
                html = `
                    <div class="question">
                        <h2>ç¬¬${state.currentQuestionIndex + 1}é¢˜ï¼ˆé€‰æ‹©é¢˜ï¼‰</h2>
                        <p>${question.question}</p>
                        <div class="options">
                `;
                
                question.options.forEach((option, index) => {
                    const isSelected = state.userAnswers[state.currentQuestionIndex] === index;
                    html += `
                        <div class="option ${isSelected ? 'selected' : ''}" data-index="${index}">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            } else if (question.type === "fill") {
                const userAnswer = state.userAnswers[state.currentQuestionIndex] || '';
                html = `
                    <div class="question">
                        <h2>ç¬¬${state.currentQuestionIndex + 1}é¢˜ï¼ˆå¡«ç©ºé¢˜ï¼‰</h2>
                        <p>${question.question}</p>
                        <div class="form-group">
                            <label for="fill-answer">æ‚¨çš„ç­”æ¡ˆï¼š</label>
                            <input type="text" id="fill-answer" placeholder="è¯·è¾“å…¥ç­”æ¡ˆï¼Œå¤šä¸ªç­”æ¡ˆç”¨è‹±æ–‡é€—å·åˆ†éš”" 
                                   value="${userAnswer}" style="width: 100%; padding: 12px;">
                            <p style="margin-top: 8px; font-size: 14px; color: #666;">
                                æç¤ºï¼šè¯·è¾“å…¥${question.requiredMatches}ä¸ªæ­£ç¡®ç­”æ¡ˆå³å¯å¾—æ»¡åˆ†
                            </p>
                        </div>
                    </div>
                `;
            }
            
            questionContainer.innerHTML = html;
            
            if (question.type === "choice") {
                document.querySelectorAll('.option').forEach(option => {
                    option.addEventListener('click', function() {
                        document.querySelectorAll('.option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        
                        this.classList.add('selected');
                        state.userAnswers[state.currentQuestionIndex] = parseInt(this.getAttribute('data-index'));
                    });
                });
            } else if (question.type === "fill") {
                const fillInput = document.getElementById('fill-answer');
                fillInput.addEventListener('input', function() {
                    state.userAnswers[state.currentQuestionIndex] = this.value.trim();
                });
                // åªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶èšç„¦
                if (!userAnswer) {
                    fillInput.focus();
                }
            }
            
            document.getElementById('prev-btn').disabled = state.currentQuestionIndex === 0;
            document.getElementById('next-btn').textContent = 
                state.currentQuestionIndex === questions.length - 1 ? 'æäº¤ç­”æ¡ˆ' : 'ä¸‹ä¸€é¢˜';
        }

        function prevQuestion() {
            if (state.currentQuestionIndex > 0) {
                state.currentQuestionIndex--;
                loadQuestion();
            }
        }

        function nextQuestion() {
            // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
            if (TimeManager.isTimeUp()) {
                alert('ç­”é¢˜æ—¶é—´å·²ç»“æŸï¼');
                submitQuiz();
                return;
            }
            
            const currentQuestion = questions[state.currentQuestionIndex];
            
            if (currentQuestion.type === "choice") {
                if (state.userAnswers[state.currentQuestionIndex] === null) {
                    alert('è¯·å…ˆé€‰æ‹©ç­”æ¡ˆï¼');
                    return;
                }
            } else if (currentQuestion.type === "fill") {
                if (!state.userAnswers[state.currentQuestionIndex] || 
                    state.userAnswers[state.currentQuestionIndex].trim() === '') {
                    alert('è¯·è¾“å…¥ç­”æ¡ˆï¼');
                    return;
                }
            }
            
            if (state.currentQuestionIndex < questions.length - 1) {
                state.currentQuestionIndex++;
                loadQuestion();
            } else {
                submitQuiz();
            }
        }

        async function submitQuiz() {
            TimeManager.stopCountdown();
            clearInterval(state.timerInterval);
            
            let score = 0;
            state.userAnswers.forEach((answer, index) => {
                const question = questions[index];
                
                if (question.type === "choice") {
                    if (answer === question.answer) {
                        score++;
                    }
                } else if (question.type === "fill") {
                    if (answer && evaluateFillAnswer(answer, question.correctAnswers, question.requiredMatches)) {
                        score++;
                    }
                }
            });
            
            // ä½¿ç”¨å®é™…ç”¨æ—¶ï¼ˆä¸è¶…è¿‡æ—¶é—´é™åˆ¶ï¼‰
            const actualTimeUsed = TimeManager.getTimeUsed();
            state.elapsedTime = actualTimeUsed;
            
            // æ˜¾ç¤ºç»“æœ
            document.getElementById('final-score').textContent = `${score}/${questions.length}`;
            document.getElementById('final-time').textContent = formatTime(actualTimeUsed);
            
            // æ˜¾ç¤ºæäº¤çŠ¶æ€
            const isValid = TimeManager.isValidSubmission();
            const resultTitle = document.getElementById('result-title');
            
            if (!isValid) {
                resultTitle.textContent = 'ç­”é¢˜å®Œæˆï¼ˆè¶…æ—¶æäº¤ï¼‰';
                resultTitle.style.color = '#e74c3c';
                StorageService.showUploadStatus('âš ï¸ è¶…æ—¶æäº¤ï¼Œæˆç»©å¯èƒ½æ— æ•ˆ', 'sync-warning');
            } else {
                resultTitle.textContent = 'ç­”é¢˜å®Œæˆï¼';
                resultTitle.style.color = '#2ecc71';
            }
            
            quizScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');
            
            // è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°
            saveResult(score, actualTimeUsed);
        }

        function saveResult(score, timeUsed) {
            const result = {
                nickname: state.currentUser,
                score: score,
                time: timeUsed,
                date: new Date().toISOString(),
                valid_submission: TimeManager.isValidSubmission()
            };
            
            StorageService.saveToLocalStorage(result);
        }

        function evaluateFillAnswer(userAnswer, correctAnswers, requiredMatches) {
            if (!userAnswer) return false;
            
            const userAnswers = userAnswer.split(',')
                .map(ans => ans.trim().toLowerCase())
                .filter(ans => ans.length > 0);
            
            let matchCount = 0;
            const matchedCorrect = new Set();
            
            userAnswers.forEach(userAns => {
                for (const correctAns of correctAnswers) {
                    const normalizedCorrect = correctAns.trim().toLowerCase();
                    if (userAns === normalizedCorrect && !matchedCorrect.has(normalizedCorrect)) {
                        matchCount++;
                        matchedCorrect.add(normalizedCorrect);
                        break;
                    }
                }
            });
            
            return matchCount >= requiredMatches;
        }

        async function createGitHubIssue() {
            const score = parseInt(document.getElementById('final-score').textContent.split('/')[0]);
            const result = {
                nickname: state.currentUser,
                score: score,
                time: state.elapsedTime,
                date: new Date().toISOString()
            };
            
            try {
                StorageService.showUploadStatus('æ­£åœ¨ç”ŸæˆGitHub Issueé“¾æ¥...', 'sync-loading');
                
                // åˆ›å»ºIssueçš„æ ‡é¢˜å’Œå†…å®¹
                const title = `æˆç»© - ${result.nickname} - å¾—åˆ†:${result.score}/${questions.length} - ç”¨æ—¶:${result.time}ç§’`;
                const body = `
# ç­”é¢˜æˆç»©

**æ˜µç§°:** ${result.nickname}
**å¾—åˆ†:** ${result.score}/${questions.length} (${((result.score / questions.length) * 100).toFixed(1)}%)
**ç”¨æ—¶:** ${result.time}ç§’ (${formatTime(result.time)})
**æ—¶é—´é™åˆ¶:** ${parseInt(document.getElementById('quiz-duration').value)}åˆ†é’Ÿ
**æäº¤çŠ¶æ€:** ${TimeManager.isValidSubmission() ? 'æœ‰æ•ˆæäº¤' : 'è¶…æ—¶æäº¤'}
**æäº¤æ—¶é—´:** ${new Date().toLocaleString('zh-CN')}
**å¼€å§‹æ—¶é—´:** ${TimeManager.quizStartTime.toLocaleString('zh-CN')}

## ç­”é¢˜è¯¦æƒ…
${generateAnswerDetails(result)}

---
*æ­¤Issueç”±ç­”é¢˜ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*
                `.trim();
                
                const encodedTitle = encodeURIComponent(title);
                const encodedBody = encodeURIComponent(body);
                const issueUrl = `https://github.com/le0632/test/issues/new?title=${encodedTitle}&body=${encodedBody}&labels=quiz-score`;
                
                StorageService.showUploadStatus('âœ… GitHub Issueé“¾æ¥å·²ç”Ÿæˆ', 'sync-success');
                // åœ¨æ–°çª—å£ä¸­æ‰“å¼€Issueåˆ›å»ºé¡µé¢
                window.open(issueUrl, '_blank');
                
            } catch (error) {
                console.error('åˆ›å»ºGitHub Issueå¤±è´¥:', error);
                StorageService.showUploadStatus('âŒ åˆ›å»ºIssueå¤±è´¥', 'sync-error');
            }
        }

        function generateAnswerDetails(result) {
            let details = '';
            state.userAnswers.forEach((answer, index) => {
                const question = questions[index];
                const isCorrect = question.type === "choice" ? 
                    answer === question.answer : 
                    evaluateFillAnswer(answer, question.correctAnswers, question.requiredMatches);
                
                details += `\n### ç¬¬${index + 1}é¢˜: ${isCorrect ? 'âœ…' : 'âŒ'}\n`;
                details += `**é—®é¢˜:** ${question.question}\n`;
                
                if (question.type === "choice") {
                    const userAnswer = question.options[answer];
                    const correctAnswer = question.options[question.answer];
                    details += `**æ‚¨çš„ç­”æ¡ˆ:** ${userAnswer || 'æœªå›ç­”'}\n`;
                    details += `**æ­£ç¡®ç­”æ¡ˆ:** ${correctAnswer}\n`;
                } else {
                    details += `**æ‚¨çš„ç­”æ¡ˆ:** ${answer || 'æœªå›ç­”'}\n`;
                    details += `**å‚è€ƒç­”æ¡ˆ:** ${question.correctAnswers.slice(0, 3).join(', ')}...\n`;
                }
            });
            return details;
        }

        async function showRanking() {
            try {
                await refreshRanking();
                
                if (!rankingScreen.classList.contains('hidden')) {
                    return;
                }
                
                resultScreen.classList.add('hidden');
                loginScreen.classList.add('hidden');
                quizScreen.classList.add('hidden');
                rankingScreen.classList.remove('hidden');
                
            } catch (error) {
                console.error('æ˜¾ç¤ºæ’è¡Œæ¦œå¤±è´¥:', error);
                alert('åŠ è½½æ’è¡Œæ¦œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        async function refreshRanking() {
            const ranking = await StorageService.loadRanking();
            displayRanking(ranking);
        }

        function displayRanking(ranking) {
            const rankingBody = document.getElementById('ranking-body');
            let html = '';
            
            if (ranking.length === 0) {
                html = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <div style="color: #7f8c8d;">
                                <p>æš‚æ— æ’è¡Œæ¦œæ•°æ®</p>
                                <p style="font-size: 14px; margin-top: 10px;">
                                    å®Œæˆç­”é¢˜åï¼Œæ‚¨çš„æˆç»©å°†è‡ªåŠ¨æ˜¾ç¤ºåœ¨è¿™é‡Œ
                                </p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                ranking.forEach((item, index) => {
                    let rowClass = '';
                    if (index === 0) rowClass = 'top-1';
                    else if (index === 1) rowClass = 'top-2';
                    else if (index === 2) rowClass = 'top-3';
                    
                    const isCurrentUser = item.nickname === state.currentUser;
                    const userBadge = isCurrentUser ? '<span class="badge badge-primary">æˆ‘</span>' : '';
                    const topBadge = index < 3 ? `<span class="badge badge-success">TOP ${index + 1}</span>` : '';
                    const sourceBadge = item.from === 'local' ? 
                        '<span class="badge badge-secondary">æœ¬åœ°</span>' : 
                        '<span class="badge badge-primary">GitHub</span>';
                    
                    const validBadge = item.valid_submission === false ? 
                        '<span class="badge badge-warning">è¶…æ—¶</span>' : '';
                    
                    const issueLink = item.issue_url ? 
                        `<a href="${item.issue_url}" target="_blank" title="æŸ¥çœ‹Issue">ğŸ”—</a>` : '';
                    
                    html += `
                        <tr class="${rowClass}">
                            <td>${index + 1}</td>
                            <td>${item.nickname} ${userBadge} ${topBadge} ${sourceBadge} ${validBadge} ${issueLink}</td>
                            <td>${item.score}/${item.total || questions.length}</td>
                            <td>${StorageService.formatTime(item.time)}</td>
                            <td>${formatDate(item.created_at)}</td>
                        </tr>
                    `;
                });
            }
            
            rankingBody.innerHTML = html;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function restartQuiz() {
            TimeManager.reset();
            resultScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        function backToStart() {
            rankingScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }

        function startTimer() {
            state.timerInterval = setInterval(() => {
                state.elapsedTime += 1;
                document.getElementById('timer').textContent = formatTime(state.elapsedTime);
            }, 1000);
        }

        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
